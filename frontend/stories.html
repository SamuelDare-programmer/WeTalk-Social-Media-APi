<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stories - WeTalk</title>
    <!-- Tailwind CDN -->
    <script src="js/tailwindcss.js"></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        colors: {
                            primary: "#2b6cee",
                            "background-dark": "#101622",
                            "surface-dark": "#192233",
                            "border-dark": "#232f48",
                        }
                    }
                }
            }
        }
    </script>
    <link href="css/stories.css" rel="stylesheet" />
</head>

<body class="bg-gray-100 dark:bg-background-dark text-slate-900 dark:text-white h-screen flex overflow-hidden">
    <!-- Navbar -->
    <script src="js/navbar.js"></script>

    <div class="flex-1 overflow-y-auto flex flex-col h-full">
        <header
            class="p-4 border-b border-gray-200 dark:border-border-dark flex justify-between items-center bg-white dark:bg-surface-dark lg:hidden">
            <h1 class="text-xl font-bold">Stories</h1>
            <button onclick="window.showStoryUploadModal()"
                class="bg-primary text-white size-10 rounded-full flex items-center justify-center shadow-lg transition transform active:scale-95">
                <span class="material-icons">add</span>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto p-4">

            <!-- Story Tray -->
            <h2 class="text-lg font-semibold mb-4">Your Feed</h2>
            <div id="story-tray" class="story-tray flex gap-4 overflow-x-auto pb-4">
                <!-- Story Avatars Injected Here -->
                <div class="animate-pulse flex gap-4">
                    <div class="w-16 h-16 bg-gray-300 dark:bg-surface-dark rounded-full"></div>
                    <div class="w-16 h-16 bg-gray-300 dark:bg-surface-dark rounded-full"></div>
                    <div class="w-16 h-16 bg-gray-300 dark:bg-surface-dark rounded-full"></div>
                </div>
            </div>

        </main>

        <!-- Upload Modal -->
        <div id="story-upload-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-surface-dark p-6 rounded-2xl w-full max-w-md">
                <h3 class="text-lg font-bold mb-4">Add to Story</h3>
                <input type="file" id="story-file-input" class="block w-full text-sm text-slate-500 mb-4
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-primary file:text-white
              hover:file:bg-blue-600
            " />
                <input type="text" id="story-caption-input" placeholder="Add a caption..."
                    class="w-full bg-gray-50 dark:bg-background-dark border border-gray-300 dark:border-border-dark rounded-lg px-4 py-2 mb-4 focus:ring-primary focus:border-primary">

                <div class="flex justify-end gap-2">
                    <button onclick="window.hideStoryUploadModal()"
                        class="px-4 py-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg">Cancel</button>
                    <button
                        onclick="storyManager.uploadStory('story-file-input', 'story-caption-input', 'story-upload-btn')"
                        id="story-upload-btn"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">Share</button>
                </div>
            </div>
        </div>

        <!-- Story Viewer Overlay -->
        <div id="story-viewer-overlay" class="hidden fixed inset-0 bg-black z-[100] flex flex-col">
            <!-- Progress Bar -->
            <div class="absolute top-0 left-0 right-0 p-2 flex gap-1 z-20" id="story-progress-container">
                <!-- Progress bars injected here -->
            </div>

            <!-- Header -->
            <div class="absolute top-4 left-4 flex items-center gap-3 z-20">
                <img id="story-viewer-avatar" src=""
                    class="w-10 h-10 rounded-full border-2 border-primary object-cover">
                <div>
                    <p id="story-viewer-username" class="text-white font-bold text-sm shadow-sm">Username</p>
                    <p id="story-viewer-time" class="text-white/80 text-xs shadow-sm">2h ago</p>
                </div>
            </div>

            <button onclick="storyManager.closeViewer()"
                class="absolute top-4 right-4 text-white hover:opacity-70 z-30">
                <span class="material-icons text-3xl">close</span>
            </button>

            <!-- Content -->
            <div class="flex-1 flex items-center justify-center relative bg-black h-full"
                onclick="handleStoryAreaClick(event)">
                <img id="story-viewer-image" class="hidden max-h-full max-w-full object-contain">
                <video id="story-viewer-video" class="hidden max-h-full max-w-full object-contain" autoplay
                    playsinline></video>

                <div class="absolute bottom-20 left-0 right-0 p-6 text-center">
                    <p id="story-viewer-caption"
                        class="text-white bg-black/30 p-2 rounded-xl inline-block backdrop-blur-md">
                    </p>
                </div>
            </div>

            <!-- View Counter (Only for owner really, but visible here for debug) -->
            <div class="absolute bottom-6 left-6 text-white text-sm flex gap-2 items-center cursor-pointer hover:bg-white/10 p-1 px-2 rounded-lg"
                onclick="handleViewersClick()">
                <span class="material-icons text-base">visibility</span>
                <span id="story-viewer-views">0</span>
            </div>

            <!-- Quick Reactions Overlay -->
            <div id="story-reaction-overlay"
                class="absolute bottom-6 right-6 flex gap-3 text-2xl z-40 bg-black/20 backdrop-blur-md p-2 rounded-full border border-white/10">
                <button onclick="storyManager.reactToStory('‚ù§Ô∏è')"
                    class="hover:scale-125 transition-transform">‚ù§Ô∏è</button>
                <button onclick="storyManager.reactToStory('üî•')"
                    class="hover:scale-125 transition-transform">üî•</button>
                <button onclick="storyManager.reactToStory('üòÇ')"
                    class="hover:scale-125 transition-transform">üòÇ</button>
                <button onclick="storyManager.reactToStory('üòÆ')"
                    class="hover:scale-125 transition-transform">üòÆ</button>
                <button onclick="storyManager.reactToStory('üò¢')"
                    class="hover:scale-125 transition-transform">üò¢</button>
            </div>

            <!-- Viewers List Modal (In-Viewer) -->
            <div id="story-viewers-modal"
                class="hidden absolute inset-0 bg-black/95 z-50 flex flex-col p-6 overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Story Activity</h3>
                    <button onclick="document.getElementById('story-viewers-modal').classList.add('hidden')"
                        class="p-2 hover:bg-white/10 rounded-full">
                        <span class="material-icons">close</span>
                    </button>
                </div>

                <div class="flex gap-4 border-b border-white/10 mb-4">
                    <button class="pb-2 border-b-2 border-primary font-bold">Viewers</button>
                    <button class="pb-2 text-white/50 hover:text-white"
                        onclick="alert('Engagement stats coming soon!')">Insights</button>
                </div>

                <div id="story-viewers-list" class="flex-1 overflow-y-auto space-y-4 custom-scrollbar">
                    <!-- Viewers/Reactions list injected here -->
                </div>
            </div>
        </div>

        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <script src="js/stories.js"></script>
        <script>
            const API_BASE = "http://127.0.0.1:8000/api/v1";
            const token = localStorage.getItem("access_token") || sessionStorage.getItem("access_token");

            if (!token) {
                window.location.href = "login.html";
                throw new Error("No token found");
            }

            const storyManager = new StoryManager(API_BASE, token);
            storyManager.onClose = () => {
                storyManager.renderTray('story-tray', { currentUserId: window.currentUserId, showCreatePlaceholder: true });
            };
            storyManager.onUploadSuccess = () => {
                storyManager.renderTray('story-tray', { currentUserId: window.currentUserId, showCreatePlaceholder: true });
            };

            window.showStoryUploadModal = () => document.getElementById('story-upload-modal').classList.remove('hidden');
            window.hideStoryUploadModal = () => document.getElementById('story-upload-modal').classList.add('hidden');

            function handleStoryAreaClick(e) {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                if (x < rect.width / 3) {
                    storyManager.prevStory();
                } else {
                    storyManager.nextStory();
                }
            }

            window.handleViewersClick = () => storyManager.openViewersModal();

            async function init() {
                // Get Me profile to know current user ID
                try {
                    const res = await fetch(`${API_BASE}/auth/users/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const user = await res.json();
                        window.currentUserId = user.id || user._id;
                    }
                } catch (e) { }

                await storyManager.fetchFeed();
                storyManager.renderTray('story-tray', { currentUserId: window.currentUserId, showCreatePlaceholder: true });
            }

            init();

        </script>
    </div>
</body>

</html>