<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walrus Proxy Upload + FastAPI</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .step { margin-bottom: 20px; padding: 10px; background: #f9f9f9; border-radius: 4px; }
        .active { border-left: 4px solid #007bff; background: #eef6fc; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #progress-container { display: none; margin-top: 10px; }
        progress { width: 100%; height: 20px; }
        pre { background: #333; color: #fff; padding: 10px; overflow-x: auto; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <h1>Walrus Proxy Upload Test</h1>

    <div class="card">
        <div id="step-1" class="step active">
            <h3>1. Select Media</h3>
            <input type="file" id="fileInput" />
            <br><br>
            <input type="text" id="captionInput" placeholder="Write a caption..." style="width: 100%; padding: 8px; box-sizing: border-box; margin-top: 5px;">
        </div>

        <div id="progress-container">
            <label>Uploading to Walrus (via Backend Proxy)...</label>
            <progress id="progressBar" value="0" max="100"></progress>
            <span id="percentage">0%</span>
        </div>

        <div id="logs" style="margin-top: 20px;">
            <h3>Logs:</h3>
            <pre id="logOutput">Waiting for user input...</pre>
        </div>

        <br>
        <button id="uploadBtn" onclick="startUpload()">Start Upload & Post</button>
    </div>

    <script>
        const API_BASE = "http://localhost:8000/api/v1/posts"; 

        function log(message, data = null) {
            const logEl = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            let text = `[${timestamp}] ${message}`;
            if (data) text += `\n${JSON.stringify(data, null, 2)}`;
            logEl.textContent = text + "\n-------------------\n" + logEl.textContent;
            console.log(message, data);
        }

        async function startUpload() {
            const fileInput = document.getElementById('fileInput');
            const captionInput = document.getElementById('captionInput');
            const file = fileInput.files[0];

            if (!file) {
                alert("Please select a file first.");
                return;
            }

            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('progressBar').removeAttribute('value'); 
            document.getElementById('percentage').textContent = "Uploading...";

            try {
                // --- PHASE A: Request Upload URL ---
                log("Step 1: Requesting upload URL from Backend...");
                
                // Use lowercase 'image' or 'video' to match Pydantic Enum
                const fileType = file.type.startsWith('video') ? 'video' : 'image';

                const initResponse = await fetch(`${API_BASE}/media/request-upload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        file_type: fileType,
                        size_bytes: file.size
                    })
                });

                if (!initResponse.ok) {
                    const errorText = await initResponse.text();
                    throw new Error(`Init Failed: ${errorText}`);
                }
                const initData = await initResponse.json();
                
                log("Backend returned IDs:", initData);
                const { internal_media_id } = initData;

                // --- PHASE B: Proxy Upload ---
                log("Step 2: Uploading via Backend Proxy...");

                const formData = new FormData();
                formData.append("file", file);

                const walrusResponse = await fetch(`${API_BASE}/media/proxy-upload/${internal_media_id}`, {
                    method: 'PUT',
                    body: formData 
                });

                if (!walrusResponse.ok) {
                    const err = await walrusResponse.text();
                    throw new Error(`Proxy Upload Failed: ${err}`);
                }

                const walrusData = await walrusResponse.json();
                log("Walrus Response:", walrusData);

                // --- EXTRACT BLOB ID (Robust Logic) ---
                let blobId;

                // Check for explicit error from Proxy
                if (walrusData.error) {
                    throw new Error(`Walrus Error: ${walrusData.details || walrusData.error}`);
                }

                // Case 1: Standard "newlyCreated" -> blobObject -> blobId
                if (walrusData.newlyCreated) {
                    blobId = walrusData.newlyCreated.blobObject ? 
                             walrusData.newlyCreated.blobObject.blobId : 
                             walrusData.newlyCreated.blobId;
                } 
                // Case 2: Deduplication "alreadyCertified" -> blobId
                else if (walrusData.alreadyCertified) {
                    blobId = walrusData.alreadyCertified.blobId;
                    log("Note: File already existed on Walrus (Deduplicated)");
                }
                // Case 3: Root-level blobId (Legacy/Proxy format)
                else if (walrusData.blobId) {
                    blobId = walrusData.blobId;
                }
                // Case 4: Root-level blobObject
                else if (walrusData.blobObject && walrusData.blobObject.blobId) {
                    blobId = walrusData.blobObject.blobId;
                }
                else {
                    console.error("Unknown Response Structure:", walrusData);
                    throw new Error("Could not find blobId. See console for details.");
                }

                log("Extracted Blob ID:", blobId);
                
                document.getElementById('progressBar').value = 100;
                document.getElementById('percentage').textContent = "100%";

                // --- PHASE C: Confirm with Backend ---
                createPost(internal_media_id, blobId, captionInput.value);

            } catch (error) {
                log("Error:", error.message);
                alert("Error: " + error.message);
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        async function createPost(internalId, blobId, caption) {
            try {
                log("Step 3: Creating Post...");

                const postResponse = await fetch(`${API_BASE}/posts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        caption: caption,
                        media: [ 
                            {
                                internal_media_id: internalId,
                                walrus_blob_id: blobId
                            }
                        ] 
                    })
                });

                if (!postResponse.ok) {
                    const errText = await postResponse.text();
                    throw new Error(`Server rejected post: ${errText}`);
                }

                const postData = await postResponse.json();
                log("SUCCESS! Post Created:", postData);
                alert("Post Created Successfully! ID: " + postData.id);

            } catch (error) {
                log("Phase C Failed:", error.message);
                alert("Creation failed. See logs.");
            } finally {
                document.getElementById('uploadBtn').disabled = false;
            }
        }
    </script>
</body>
</html>
